;; PgBouncer Configuration for BROMS System
;; Optimized for Django + OPC UA background threads + Real-time SCADA telemetry
;; Created: 2026-02-05

[databases]
;; Database connection string
;; Format: dbname = host=hostname port=port dbname=dbname
roams_db = host=127.0.0.1 port=5432 dbname=roams_db

;; Fallback database for pgbouncer console commands
;; * = host=127.0.0.1 port=5432

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

;; IP address or * to listen on all interfaces
listen_addr = 127.0.0.1

;; Port for PgBouncer (Django will connect to this instead of 5432)
listen_port = 6432

;; Unix socket location (optional, for local connections)
unix_socket_dir = /var/run/postgresql

;;;
;;; Authentication settings
;;;

;; Authentication type (trust, plain, md5, scram-sha-256)
;; md5 is most common for PostgreSQL
auth_type = md5

;; Path to user credentials file (format: "username" "password")
auth_file = /etc/pgbouncer/userlist.txt

;;;
;;; Connection pooling mode
;;;

;; Pool mode for BROMS:
;; - session: One server connection per client (safest, but less efficient)
;; - transaction: Server connection returned after transaction ends (RECOMMENDED)
;; - statement: Server connection returned after each statement (breaks Django)
;;
;; For Django with OPC UA background threads, use TRANSACTION mode
pool_mode = transaction

;;;
;;; Connection limits
;;;

;; Maximum client connections (total from Django + OPC UA threads + Admin)
;; Calculation: 50 stations Ã— 1 thread + 20 web workers + 10 admin + buffer = 200
max_client_conn = 200

;; Total PostgreSQL server connections allowed for this database
;; Keep low to prevent exhausting PostgreSQL max_connections (typically 100-200)
;; BROMS optimization: 25 connections supports high concurrency with transaction pooling
default_pool_size = 25

;; Extra connections for emergency use when pool is full
reserve_pool_size = 5

;; Maximum time (seconds) a connection can stay in reserve pool before being closed
reserve_pool_timeout = 3

;; Maximum database connections per user
;; Set to 0 for unlimited (controlled by default_pool_size)
max_db_connections = 0

;; Maximum user connections (0 = unlimited, controlled by max_client_conn)
max_user_connections = 0

;;;
;;; Connection lifetime and timeouts
;;;

;; Close server connection after this many seconds (prevents stale connections)
;; BROMS: 1 hour - balances connection reuse with freshness
server_lifetime = 3600

;; Close unused server connections after this many seconds
;; BROMS: 10 minutes - releases idle connections during low activity
server_idle_timeout = 600

;; Maximum time (seconds) to wait for a connection from the pool
;; If pool is full, client waits this long before getting error
;; BROMS: 30 seconds - long enough for OPC UA bursts, short enough to fail fast
server_connect_timeout = 30

;; How long to wait for server response during login (seconds)
server_login_retry = 15

;; Abort connection attempt if taking longer than this (seconds)
query_timeout = 0

;; Abort queries running longer than this (0 = disabled)
;; BROMS: Disabled - Django handles query timeouts in settings.py
query_wait_timeout = 120

;; Client idle timeout (seconds) - disconnect clients idle for this long
;; BROMS: 0 (disabled) - OPC UA threads maintain persistent connections
client_idle_timeout = 0

;; Client login timeout (seconds)
client_login_timeout = 60

;;;
;;; Health checks and reconnection
;;;

;; Send test query on server connection (verify it's alive)
;; Options: 0 = disabled, 1 = SELECT 1
server_check_query = SELECT 1

;; How often to run server_check_query on idle connections (seconds)
;; BROMS: 60 seconds - detect dead connections from PostgreSQL restarts
server_check_delay = 60

;; Reset query parameters when server connection is returned to pool
;; BROMS: Disable - Django manages transaction state properly
server_reset_query = DISCARD ALL

;; Run server_reset_query on fresh connections or only on dirty ones
;; Options: 0 = only on dirty connections, 1 = always
server_reset_query_always = 0

;;;
;;; Logging and statistics
;;;

;; Log level: 0 = disabled, 1 = error, 2 = warning, 3 = info, 4 = debug
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; Log queries (WARNING: Very verbose in production!)
;; BROMS: Disable in production, enable for debugging
log_stats = 1
stats_period = 60

;; Syslog settings (optional)
syslog = 0
; syslog_ident = pgbouncer
; syslog_facility = daemon

;;;
;;; Dangerous timeouts
;;;

;; Close connections that have been waiting for query result for longer than this
;; BROMS: 0 (disabled) - some admin queries on 126K breaches may take time
server_round_robin = 0

;;;
;;; TLS settings (optional, for encrypted connections)
;;;

;; Disable SSL for local connections (enable if connecting remotely)
;; client_tls_sslmode = disable
;; client_tls_key_file =
;; client_tls_cert_file =
;; client_tls_ca_file =
;; client_tls_protocols = secure
;; client_tls_ciphers = default

;;;
;;; Security
;;;

;; Disable dangerous commands
ignore_startup_parameters = extra_float_digits

;; Admin users (can access pgbouncer console via psql -p 6432 -U pgbouncer pgbouncer)
admin_users = postgres

;; Stats users (can view statistics but not modify)
stats_users = postgres

;;;
;;; Performance tuning
;;;

;; Use SO_REUSEPORT to allow multiple PgBouncer instances (advanced)
so_reuseport = 0

;; TCP keepalive settings (detect broken connections)
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;; DNS lookup caching (seconds) - speed up hostname resolution
dns_max_ttl = 15
dns_nxdomain_ttl = 15

;; Packet buffer size (bytes) - default is usually fine
pkt_buf = 4096

;; Max packet size (bytes)
max_packet_size = 2147483647

;; Listen queue size (backlog for pending connections)
listen_backlog = 128

;; Disable Nagle algorithm for lower latency
tcp_nodelay = 1

;; TCP user timeout (milliseconds) - abort connection if no response
tcp_user_timeout = 0

;;;
;;; Application name
;;;

application_name_add_host = 1
